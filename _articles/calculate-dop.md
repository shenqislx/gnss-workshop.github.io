Sherman–Morrison 公式是一个**在线性代数中非常有用的秩-1矩阵逆更新公式**，
在GNSS、滤波、机器学习和信号处理等场景中都频繁使用。

我们一步步从直观到推导讲清楚 👇

---

## 🧩 一、背景：为什么需要它

在GNSS定位或其他实时系统中，经常有这样的情况：

[
A = G^T G
]
我们已经计算好了 (A^{-1})（记作 (Q)）。

如果系统只**新增或删除一颗卫星**，
意味着 (A) 只变化了一个秩-1的修正：

[
A' = A + u v^T
]

比如在DOP计算中，
新增一颗卫星的观测行向量 (g)，则
[
A' = G'^T G' = G^T G + g^T g = A + g^T g
]
这里 (u = g^T)，(v = g)。

此时我们希望快速算出 (A'^{-1})，而不是重算整个矩阵求逆。

---

## ⚙️ 二、Sherman–Morrison 公式内容

对于一个可逆矩阵 (A) 和两个列向量 (u, v)，
若 (1 + v^T A^{-1} u \neq 0)，则：

[
(A + u v^T)^{-1}
= A^{-1} - \frac{A^{-1} u v^T A^{-1}}{1 + v^T A^{-1} u}
]

---

## 📖 三、直观理解

### 1️⃣ 矩阵“加秩1”的效果

(A + u v^T) 表示在原矩阵 (A) 上，
增加了一个“方向为 (u)、强度为 (v^T)”的微小扰动。

而 (A^{-1}) 是一个非常昂贵的操作，
但如果这个扰动只有秩1（即只影响一个方向），
我们可以用一次外积修正 (A^{-1})。

---

### 2️⃣ 修正项意义

修正项：
[
\frac{A^{-1} u v^T A^{-1}}{1 + v^T A^{-1} u}
]
可以看作：

* 分子：扰动的传播（通过 (A^{-1}) 左右传播）
* 分母：扰动对整体系统的放大因子（标量）

因此，这一项是对原逆矩阵的**低秩补偿修正**。

---

## 🧮 四、推导思路（一步步）

我们要找一个矩阵 (X)，使得：
[
(A + u v^T) X = I
]

假设 (X = A^{-1} + \Delta)，代入上式：
[
(A + u v^T)(A^{-1} + \Delta) = I
]
展开：
[
I + A\Delta + u v^T A^{-1} + u v^T \Delta = I
]
化简：
[
A\Delta + u v^T A^{-1} + u v^T \Delta = 0
]
左乘 (A^{-1})：
[
\Delta + A^{-1} u v^T A^{-1} + A^{-1} u v^T \Delta = 0
]

令 (y = A^{-1} u)，得：
[
\Delta + y v^T A^{-1} + y v^T \Delta = 0
]

将 (\Delta) 移项：
[
\Delta = - y v^T (A^{-1} + \Delta)
]

代入自身：
[
\Delta = - y v^T A^{-1} - y v^T \Delta
]
[
\Rightarrow (I + y v^T)\Delta = - y v^T A^{-1}
]
两边右乘 ((I + y v^T)^{-1})，
根据矩阵逆的**Woodbury恒等式**的秩1特例：
[
(I + y v^T)^{-1} = I - \frac{y v^T}{1 + v^T y}
]
代入得到：
[
\Delta = -\frac{y v^T A^{-1}}{1 + v^T y}
]
[
\Rightarrow X = A^{-1} + \Delta = A^{-1} - \frac{A^{-1} u v^T A^{-1}}{1 + v^T A^{-1} u}
]
证毕 ✅

---

## 🧠 五、删除元素的逆公式（减秩）

如果是删除一颗卫星（矩阵减少秩1），则：
[
A' = A - u v^T
]
只需把公式中的 “+” 改成 “−”：
[
(A - u v^T)^{-1}
= A^{-1} + \frac{A^{-1} u v^T A^{-1}}{1 - v^T A^{-1} u}
]
这就是我们在前面代码中 `update_Q_remove()` 使用的版本。

---

## 🧩 六、与Woodbury矩阵恒等式的关系

Sherman–Morrison 是更一般公式——Woodbury恒等式的特例（当秩为1时）：

[
(A + UCV^T)^{-1} = A^{-1} - A^{-1}U(C^{-1} + V^T A^{-1}U)^{-1}V^T A^{-1}
]
当 (U=u, V=v, C=1)，就变成 Sherman–Morrison。

---

## ⚡ 七、应用场景

| 场景                 | 用途             |
| ------------------ | -------------- |
| GNSS DOP实时更新       | 新增/删除卫星时快速更新 Q |
| 卡尔曼滤波              | 更新协方差逆矩阵       |
| 机器学习（LMS, Ridge回归） | 在线数据增量学习       |
| 图像/信号处理            | 局部矩阵更新加速       |

---

## ✅ 八、数值稳定性提示

* 需要确保分母 (1 + v^T A^{-1} u) 不接近0，否则不稳定；
* 在GNSS应用中，(g Q g^T) 通常很小，数值稳定；
* 可以用双精度浮点（`double`）计算避免舍入误差。

